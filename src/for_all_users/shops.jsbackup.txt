import React, { useEffect, useState } from 'react';
import { Link } from 'react-router-dom';
import Navbar from '../layouts/Navbar';
import Footer from '../layouts/Footer';
import axios from 'axios';
import { safeBase64Encode } from '../common_component/EnEdUtils';
import useProductAndCategory from '../common_component/useProductAndCategory';

const Shops = () => {
    const [categories, setCategories] = useState([]);
    const [vendors, setVendors] = useState([]);
    const [searchedVendors, setSearchedVendors] = useState([]);
    const [searchResult, setSearchResult] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [selectCategory, setSelectCategory] = useState('');
    const [filterResult, setFilterResult] = useState([]);

    const product = useProductAndCategory()

    useEffect(() => {
        (
            async () => {
                const { data } = await axios.get('/shop-category')
                setCategories(data.shop_categories);
            }
        )()
    }, []);

    useEffect(() => {
        (
            async () => {

                const { data } = await axios.get('/shops')
                setVendors(data.shops);
            }
        )()
    }, []);

    function searchShops(param) {
        if (param.length > 0) {
            const filteredVendors = vendors.filter((vendor) => vendor.shop_name.toLowerCase().includes(param.toLowerCase())).slice(0, 5);
            setSearchTerm(param)
            setSearchedVendors(filteredVendors);
        } else {
            setSearchedVendors("")
            handleSearchShops()
        }
    }

    function handleFilter() {
        if (selectCategory !== 'all-shops') {
            const filteredVendors = vendors.filter((vendor) => Number(vendor.Shop_type) === Number(selectCategory));
            setFilterResult(filteredVendors);
            console.log('hello')
        }else{
            setFilterResult(vendors)
        }
    }

    function handleSearchShops() {
        let filteredVendors;
        if (filterResult.length > 0 && searchTerm.length > 0) {
            filteredVendors = filterResult.filter((vendor) => vendor.shop_name.toLowerCase().includes(searchTerm.toLowerCase()));
            setSearchResult(filteredVendors);
            setSearchedVendors([])
        }
        else if (selectCategory !== 'all-shops' && searchTerm.length > 0) {
            filteredVendors = vendors.filter((vendor) => vendor.shop_name.toLowerCase().includes(searchTerm.toLowerCase()));
            setSearchResult(filteredVendors);
            setSearchedVendors([])
        } else {
            setSearchResult([])
            handleFilter()
        }
    }



    return (
        <>
            <div className="users-pages">
                <Navbar />
                <main style={{ paddingTop: '80px', minHeight: '80vh' }}>
                    <div className="container py-5">
                        {/* Hero Section */}
                        <section className="vendors-hero mb-5 py-5 bg-light rounded-4">
                            <div className="container text-center">
                                <h1 className="display-4 fw-bold mb-4">Our Trusted Vendors</h1>
                                <p className="lead mb-4 col-lg-8 mx-auto">
                                    Shop from our network of carefully vetted vendors who bring you quality products and exceptional service.
                                </p>
                                <div className="search-box mx-auto" style={{ maxWidth: '600px' }}>
                                    <div className="input-group">
                                        <input
                                            type="text"
                                            className="form-control form-control-lg"
                                            placeholder="Search Shops..."
                                            aria-label="Search vendors"
                                            onChange={(e) => searchShops(e.target.value)}
                                        />
                                        <button className="btn btn-primary" onClick={handleSearchShops} type="button">
                                            <i className="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                    {searchedVendors.length > 0 ?
                                        <div className="temp-search-results form-control position-absolute">
                                            <ul className="list-group" style={{ textAlign: "left" }}>
                                                {searchedVendors.map((vendor) => (
                                                    <li key={vendor.id} className="list-unstyled mb-3">
                                                        <Link
                                                            className='text-decoration-none text-dark'
                                                            to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`}
                                                        >
                                                            {vendor.shop_name}
                                                        </Link>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                        : ""
                                    }
                                </div>
                            </div>
                        </section>

                        {/* Filter Section */}
                        <section className="vendors-filter mb-5">
                            <div className="row g-3">
                                <div className="col-md-6 col-lg-3">
                                    <select onChange={(e) => setSelectCategory(e.target.value)} className="form-select">
                                        <option className={`${selectCategory ? 'd-none' : ''}`}>Filter Shop by Category</option>
                                        <option value="all-shops">All Shops</option>
                                        {categories.map((category, index) => (
                                            <option key={index} value={category.id}>{category.Shop_category}</option>
                                        ))}
                                    </select>
                                </div>
                                {/* <div className="col-md-6 col-lg-3">
                                    <select className="form-select">
                                        <option>All Ratings</option>
                                        <option>4+ Stars</option>
                                        <option>3+ Stars</option>
                                        <option>2+ Stars</option>
                                        <option>1+ Stars</option>
                                    </select>
                                </div>
                                <div className="col-md-6 col-lg-3">
                                    <select className="form-select">
                                        <option>Sort By: Featured</option>
                                        <option>Highest Rated</option>
                                        <option>Most Products</option>
                                        <option>Newest</option>
                                        <option>Alphabetical</option>
                                    </select>
                                </div> */}
                                <div className="col-md-6 col-lg-3">
                                    <button onClick={handleFilter} className="btn btn-outline-primary w-100">
                                        <i className="fas fa-filter me-2"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </section>

                        {/* Vendors Grid */}
                        <section className="vendors-grid">
                            <div className="row g-4">
                                {

                                    filterResult.length > 0 ?
                                        searchResult.length > 0 ?
                                        searchResult.map(vendor => (
                                            <div key={vendor.id} className="col-lg-4 col-md-6">
                                                <div className="vendor-card card border-0 shadow-sm h-100 hover-effect">
                                                    <div className="card-body p-4">
                                                        <div className="d-flex align-items-start mb-4">
                                                            <div className="vendor-logo me-4">
                                                                <img
                                                                    src={'http://127.0.0.1:8000' + vendor.shop_owner_image}
                                                                    alt={vendor.shop_name}
                                                                    className="rounded-circle img-thumbnail"
                                                                    style={{ width: '80px', height: '80px' }}
                                                                />
                                                            </div>
                                                            <div className="vendor-info flex-grow-1">
                                                                <h4 className="vendor-name mb-1">
                                                                    <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="text-decoration-none">
                                                                        {vendor.shop_name}
                                                                    </Link>
                                                                </h4>
                                                                {/* <div className="vendor-rating mb-2">
                                                            {[...Array(5)].map((_, i) => {
                                                                const ratingValue = i + 1;
                                                                return (
                                                                    <i
                                                                        key={i}
                                                                        className={
                                                                            ratingValue <= Math.floor(vendor.rating)
                                                                                ? 'fas fa-star text-warning'
                                                                                : ratingValue - 0.5 <= vendor.rating
                                                                                    ? 'fas fa-star-half-alt text-warning'
                                                                                    : 'far fa-star text-warning'
                                                                        }
                                                                    ></i>
                                                                );
                                                            })}
                                                            <span className="text-muted ms-1">({vendor.reviewCount})</span>
                                                        </div> */}
                                                                <p className="vendor-category small text-muted mb-2">
                                                                    <i className="fas fa-tag me-1"></i>
                                                                    {categories.find(category => category.id === vendor.Shop_type)?.Shop_category}
                                                                </p>
                                                                <p className="vendor-products small text-muted">
                                                                    <i className="fas fa-boxes me-1"></i>
                                                                    {product.allProducts.filter(product => product.shop_owner_username === vendor.owner_username).length} products
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <p className="vendor-description mb-4">{vendors.description}</p>
                                                        <div className="d-flex justify-content-between align-items-center">
                                                            <span className="small text-muted">
                                                                <i className="fas fa-calendar-alt me-1"></i> Joined on {vendor.created_at.split('T')[0]}
                                                            </span>
                                                            <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="btn btn-outline-primary btn-sm">
                                                                Visit Store
                                                            </Link>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )):
                                        filterResult.map(vendor => (
                                            <div key={vendor.id} className="col-lg-4 col-md-6">
                                                <div className="vendor-card card border-0 shadow-sm h-100 hover-effect">
                                                    <div className="card-body p-4">
                                                        <div className="d-flex align-items-start mb-4">
                                                            <div className="vendor-logo me-4">
                                                                <img
                                                                    src={'http://127.0.0.1:8000' + vendor.shop_owner_image}
                                                                    alt={vendor.shop_name}
                                                                    className="rounded-circle img-thumbnail"
                                                                    style={{ width: '80px', height: '80px' }}
                                                                />
                                                            </div>
                                                            <div className="vendor-info flex-grow-1">
                                                                <h4 className="vendor-name mb-1">
                                                                    <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="text-decoration-none">
                                                                        {vendor.shop_name}
                                                                    </Link>
                                                                </h4>
                                                                {/* <div className="vendor-rating mb-2">
                                                            {[...Array(5)].map((_, i) => {
                                                                const ratingValue = i + 1;
                                                                return (
                                                                    <i
                                                                        key={i}
                                                                        className={
                                                                            ratingValue <= Math.floor(vendor.rating)
                                                                                ? 'fas fa-star text-warning'
                                                                                : ratingValue - 0.5 <= vendor.rating
                                                                                    ? 'fas fa-star-half-alt text-warning'
                                                                                    : 'far fa-star text-warning'
                                                                        }
                                                                    ></i>
                                                                );
                                                            })}
                                                            <span className="text-muted ms-1">({vendor.reviewCount})</span>
                                                        </div> */}
                                                                <p className="vendor-category small text-muted mb-2">
                                                                    <i className="fas fa-tag me-1"></i>
                                                                    {categories.find(category => category.id === vendor.Shop_type)?.Shop_category}
                                                                </p>
                                                                <p className="vendor-products small text-muted">
                                                                    <i className="fas fa-boxes me-1"></i>
                                                                    {product.allProducts.filter(product => product.shop_owner_username === vendor.owner_username).length} products
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <p className="vendor-description mb-4">{vendors.description}</p>
                                                        <div className="d-flex justify-content-between align-items-center">
                                                            <span className="small text-muted">
                                                                <i className="fas fa-calendar-alt me-1"></i> Joined on {vendor.created_at.split('T')[0]}
                                                            </span>
                                                            <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="btn btn-outline-primary btn-sm">
                                                                Visit Store
                                                            </Link>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))


                                        : 
                                        searchResult.length > 0 ?
                                        searchResult.map(vendor => (
                                            <div key={vendor.id} className="col-lg-4 col-md-6">
                                                <div className="vendor-card card border-0 shadow-sm h-100 hover-effect">
                                                    <div className="card-body p-4">
                                                        <div className="d-flex align-items-start mb-4">
                                                            <div className="vendor-logo me-4">
                                                                <img
                                                                    src={'http://127.0.0.1:8000' + vendor.shop_owner_image}
                                                                    alt={vendor.shop_name}
                                                                    className="rounded-circle img-thumbnail"
                                                                    style={{ width: '80px', height: '80px' }}
                                                                />
                                                            </div>
                                                            <div className="vendor-info flex-grow-1">
                                                                <h4 className="vendor-name mb-1">
                                                                    <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="text-decoration-none">
                                                                        {vendor.shop_name}
                                                                    </Link>
                                                                </h4>
                                                                {/* <div className="vendor-rating mb-2">
                                                            {[...Array(5)].map((_, i) => {
                                                                const ratingValue = i + 1;
                                                                return (
                                                                    <i
                                                                        key={i}
                                                                        className={
                                                                            ratingValue <= Math.floor(vendor.rating)
                                                                                ? 'fas fa-star text-warning'
                                                                                : ratingValue - 0.5 <= vendor.rating
                                                                                    ? 'fas fa-star-half-alt text-warning'
                                                                                    : 'far fa-star text-warning'
                                                                        }
                                                                    ></i>
                                                                );
                                                            })}
                                                            <span className="text-muted ms-1">({vendor.reviewCount})</span>
                                                        </div> */}
                                                                <p className="vendor-category small text-muted mb-2">
                                                                    <i className="fas fa-tag me-1"></i>
                                                                    {categories.find(category => category.id === vendor.Shop_type)?.Shop_category}
                                                                </p>
                                                                <p className="vendor-products small text-muted">
                                                                    <i className="fas fa-boxes me-1"></i>
                                                                    {product.allProducts.filter(product => product.shop_owner_username === vendor.owner_username).length} products
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <p className="vendor-description mb-4">{vendors.description}</p>
                                                        <div className="d-flex justify-content-between align-items-center">
                                                            <span className="small text-muted">
                                                                <i className="fas fa-calendar-alt me-1"></i> Joined on {vendor.created_at.split('T')[0]}
                                                            </span>
                                                            <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="btn btn-outline-primary btn-sm">
                                                                Visit Store
                                                            </Link>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )):

                                        vendors.map(vendor => (
                                            <div key={vendor.id} className="col-lg-4 col-md-6">
                                                <div className="vendor-card card border-0 shadow-sm h-100 hover-effect">
                                                    <div className="card-body p-4">
                                                        <div className="d-flex align-items-start mb-4">
                                                            <div className="vendor-logo me-4">
                                                                <img
                                                                    src={'http://127.0.0.1:8000' + vendor.shop_owner_image}
                                                                    alt={vendor.shop_name}
                                                                    className="rounded-circle img-thumbnail"
                                                                    style={{ width: '80px', height: '80px' }}
                                                                />
                                                            </div>
                                                            <div className="vendor-info flex-grow-1">
                                                                <h4 className="vendor-name mb-1">
                                                                    <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="text-decoration-none">
                                                                        {vendor.shop_name}
                                                                    </Link>
                                                                </h4>
                                                                {/* <div className="vendor-rating mb-2">
                                                            {[...Array(5)].map((_, i) => {
                                                                const ratingValue = i + 1;
                                                                return (
                                                                    <i
                                                                        key={i}
                                                                        className={
                                                                            ratingValue <= Math.floor(vendor.rating)
                                                                                ? 'fas fa-star text-warning'
                                                                                : ratingValue - 0.5 <= vendor.rating
                                                                                    ? 'fas fa-star-half-alt text-warning'
                                                                                    : 'far fa-star text-warning'
                                                                        }
                                                                    ></i>
                                                                );
                                                            })}
                                                            <span className="text-muted ms-1">({vendor.reviewCount})</span>
                                                        </div> */}
                                                                <p className="vendor-category small text-muted mb-2">
                                                                    <i className="fas fa-tag me-1"></i>
                                                                    {categories.find(category => category.id === vendor.Shop_type)?.Shop_category}
                                                                </p>
                                                                <p className="vendor-products small text-muted">
                                                                    <i className="fas fa-boxes me-1"></i>
                                                                    {product.allProducts.filter(product => product.shop_owner_username === vendor.owner_username).length} products
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <p className="vendor-description mb-4">{vendors.description}</p>
                                                        <div className="d-flex justify-content-between align-items-center">
                                                            <span className="small text-muted">
                                                                <i className="fas fa-calendar-alt me-1"></i> Joined on {vendor.created_at.split('T')[0]}
                                                            </span>
                                                            <Link to={`/shop/${vendor.slug}/${safeBase64Encode(vendor.owner_username)}`} className="btn btn-outline-primary btn-sm">
                                                                Visit Store
                                                            </Link>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                }

                            </div>
                        </section>

                        {/* Pagination */}
                        <nav aria-label="Vendors pagination" className="mt-5">
                            <ul className="pagination justify-content-center">
                                <li className="page-item disabled">
                                    <a className="page-link" href="#" tabIndex="-1">Previous</a>
                                </li>
                                <li className="page-item active"><a className="page-link" href="#">1</a></li>
                                <li className="page-item"><a className="page-link" href="#">2</a></li>
                                <li className="page-item"><a className="page-link" href="#">3</a></li>
                                <li className="page-item">
                                    <a className="page-link" href="#">Next</a>
                                </li>
                            </ul>
                        </nav>

                        {/* Become a Vendor CTA */}
                        <section className="become-vendor-cta mt-5 py-5 bg-light rounded-4">
                            <div className="container text-center">
                                <h2 className="mb-4">Want to become a ShopSphere vendor?</h2>
                                <p className="lead mb-4 col-lg-8 mx-auto">
                                    Join our marketplace and reach millions of customers worldwide with your products.
                                </p>
                                <button className="btn btn-primary btn-lg px-4">
                                    Apply Now <i className="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </section>
                    </div>
                </main>
                <Footer />
            </div>
        </>
    );
};

export default Shops;
